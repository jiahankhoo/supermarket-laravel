# 新功能说明

## 客户取消订单功能

### 功能概述
客户可以申请取消订单，但需要商家批准。这确保了订单管理的安全性和可控性。

### 主要特性

#### 1. 取消申请条件
- 只有订单状态为"待处理"或"处理中"的订单可以申请取消
- 每个订单只能申请一次取消
- 已完成的订单无法申请取消

#### 2. 客户操作流程
1. 在订单详情页面点击"申请取消订单"按钮
2. 填写取消原因（必填）
3. 提交申请，等待商家审核

#### 3. 商家审核流程
1. 在订单详情页面查看取消申请
2. 点击"回复取消申请"按钮
3. 填写回复内容和处理决定：
   - **批准取消**：订单状态变为"已取消"，商品库存自动恢复
   - **拒绝取消**：订单状态变为"处理中"，继续正常处理

#### 4. 状态显示
- **申请取消中**：客户已提交取消申请，等待商家回复
- **等待回复**：在订单列表中显示等待商家回复的提示

### 数据库变更
- 添加了取消申请相关字段：
  - `cancellation_reason`：取消原因
  - `cancellation_requested_at`：申请时间
  - `admin_response`：商家回复
  - `admin_responded_at`：回复时间
  - `responded_by`：回复人ID
- 更新了订单状态枚举，添加了`cancellation_requested`状态

## 联系商家功能

### 功能概述
客户可以通过系统联系商家，询问问题或寻求帮助。

### 主要特性

#### 1. 联系表单
- 主题输入（必填）
- 消息内容（必填）
- 相关订单选择（可选）
- 表单验证和错误提示

#### 2. 订单关联
- 客户可以选择关联特定订单
- 帮助商家更好地理解客户问题

#### 3. 管理员查看
- 管理员可以查看所有联系消息
- 提供联系消息管理界面

#### 4. 其他联系方式
- 显示客服电话和邮箱
- 提供多种联系渠道

### 路由说明

#### 取消订单相关路由
- `GET /orders/{order}/cancellation-form` - 显示取消申请表单
- `POST /orders/{order}/request-cancellation` - 提交取消申请
- `POST /orders/{order}/respond-cancellation` - 商家回复取消申请

#### 联系商家相关路由
- `GET /contact` - 显示联系表单
- `POST /contact` - 提交联系消息
- `GET /admin/contact-messages` - 管理员查看联系消息

### 界面更新

#### 1. 订单详情页面
- 添加取消申请按钮（仅对符合条件的订单显示）
- 显示取消申请信息（如果有）
- 添加商家回复模态框
- 更新状态显示

#### 2. 订单列表页面
- 更新状态显示，使用新的状态文本和徽章
- 显示等待回复提示

#### 3. 导航栏
- 添加"联系商家"链接

#### 4. 管理员仪表板
- 添加"联系消息"管理按钮

### 使用方法

#### 客户申请取消订单
1. 登录系统
2. 进入"我的订单"
3. 点击要取消的订单
4. 点击"申请取消订单"按钮
5. 填写取消原因并提交

#### 商家处理取消申请
1. 管理员登录系统
2. 进入订单详情页面
3. 查看取消申请信息
4. 点击"回复取消申请"按钮
5. 填写回复内容和处理决定
6. 提交回复

#### 联系商家
1. 点击导航栏的"联系商家"
2. 填写主题和消息内容
3. 可选择关联订单
4. 提交消息

### 技术实现

#### 模型更新
- `Order`模型添加了新的字段和关系
- 添加了状态检查方法
- 添加了状态显示属性

#### 控制器更新
- `OrderController`添加了取消申请相关方法
- 新增`ContactController`处理联系功能

#### 视图更新
- 创建了取消申请表单视图
- 更新了订单详情和列表视图
- 创建了联系表单和管理视图

### 注意事项
1. 取消申请一旦提交无法修改
2. 商家回复后，客户无法再次申请取消
3. 联系消息目前是模拟功能，实际部署时需要添加邮件发送或数据库存储
4. 所有功能都需要用户登录才能使用 