# 🚀 Laravel 超市系统快速部署指南

## 📋 部署前准备

### 1. 服务器要求
- Linux 服务器 (Ubuntu/CentOS)
- PHP >= 8.1
- MySQL/MariaDB 或 SQLite
- Web 服务器 (Apache/Nginx)
- SSH 访问权限

### 2. 本地准备
确保你的项目已经完成以下步骤：
```bash
# 更新依赖
composer update

# 清除缓存
php artisan config:clear
php artisan cache:clear
php artisan view:clear
```

## 📤 项目上传方法

### 方法 1: 使用 Git (推荐)
```bash
# 在服务器上执行
cd /var/www
git clone https://github.com/your-username/supermarket-laravel.git
cd supermarket-laravel
```

### 方法 2: 使用 SCP 上传
```bash
# 在本地执行，上传项目文件
scp -r app bootstrap config database public resources routes storage tests artisan composer.json composer.lock package.json user@your-server:/tmp/supermarket-laravel/

# 在服务器上移动文件
sudo mv /tmp/supermarket-laravel /var/www/
sudo chown -R $USER:$USER /var/www/supermarket-laravel
```

### 方法 3: 使用 SFTP 工具
1. 使用 FileZilla、WinSCP 等工具
2. 连接到服务器
3. 上传项目文件夹到 `/var/www/supermarket-laravel`

## ⚙️ 服务器端配置

### 步骤 1: 安装 Composer
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install composer

# CentOS/RHEL
sudo yum install composer

# 验证安装
composer --version
```

### 步骤 2: 安装 PHP 和扩展
```bash
# Ubuntu/Debian
sudo apt install php8.1 php8.1-cli php8.1-fpm php8.1-mysql php8.1-sqlite3 php8.1-mbstring php8.1-xml php8.1-curl php8.1-zip php8.1-gd

# CentOS/RHEL
sudo yum install php php-cli php-fpm php-mysqlnd php-sqlite3 php-mbstring php-xml php-curl php-zip php-gd
```

### 步骤 3: 配置项目
```bash
cd /var/www/supermarket-laravel

# 安装依赖
composer install --no-dev --optimize-autoloader

# 复制环境配置
cp .env.example .env

# 生成应用密钥
php artisan key:generate

# 设置文件权限
sudo chmod -R 755 storage bootstrap/cache
sudo chown -R www-data:www-data storage bootstrap/cache

# 创建存储链接
php artisan storage:link
```

### 步骤 4: 配置数据库

#### 选项 A: MySQL
```bash
# 创建数据库
mysql -u root -p
CREATE DATABASE supermarket_laravel;
CREATE USER 'supermarket_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON supermarket_laravel.* TO 'supermarket_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;

# 编辑 .env 文件
nano .env
```

在 `.env` 文件中设置：
```env
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=supermarket_laravel
DB_USERNAME=supermarket_user
DB_PASSWORD=your_password
```

#### 选项 B: SQLite
```bash
# 创建 SQLite 数据库
touch database/database.sqlite

# 编辑 .env 文件
nano .env
```

在 `.env` 文件中设置：
```env
DB_CONNECTION=sqlite
DB_DATABASE=/var/www/supermarket-laravel/database/database.sqlite
```

### 步骤 5: 运行迁移
```bash
# 运行数据库迁移
php artisan migrate

# 运行数据填充 (可选)
php artisan db:seed
```

### 步骤 6: 配置 Web 服务器

#### Apache 配置
```bash
# 安装 Apache
sudo apt install apache2
sudo a2enmod rewrite

# 创建虚拟主机配置
sudo nano /etc/apache2/sites-available/supermarket-laravel.conf
```

添加以下内容：
```apache
<VirtualHost *:80>
    ServerName localhost
    DocumentRoot /var/www/supermarket-laravel/public

    <Directory /var/www/supermarket-laravel/public>
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/supermarket-laravel_error.log
    CustomLog ${APACHE_LOG_DIR}/supermarket-laravel_access.log combined
</VirtualHost>
```

```bash
# 启用站点
sudo a2ensite supermarket-laravel.conf
sudo a2dissite 000-default.conf
sudo systemctl restart apache2
```

#### Nginx 配置
```bash
# 安装 Nginx
sudo apt install nginx

# 创建配置文件
sudo nano /etc/nginx/sites-available/supermarket-laravel
```

添加以下内容：
```nginx
server {
    listen 80;
    server_name localhost;
    root /var/www/supermarket-laravel/public;

    index index.php;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }
}
```

```bash
# 启用站点
sudo ln -s /etc/nginx/sites-available/supermarket-laravel /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default
sudo nginx -t
sudo systemctl restart nginx
```

### 步骤 7: 清除缓存
```bash
php artisan config:clear
php artisan cache:clear
php artisan view:clear
php artisan route:clear
```

## 🧪 测试部署

### 检查应用状态
```bash
# 检查 PHP 版本
php --version

# 检查 Composer
composer --version

# 检查 Laravel
php artisan --version

# 测试数据库连接
php artisan tinker
>>> DB::connection()->getPdo();
```

### 访问网站
在浏览器中访问 `http://your-server-ip`

## 🔒 安全配置

### 设置防火墙
```bash
# Ubuntu/Debian
sudo ufw allow 22
sudo ufw allow 80
sudo ufw allow 443
sudo ufw enable

# CentOS/RHEL
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

### 生产环境配置
编辑 `.env` 文件：
```env
APP_ENV=production
APP_DEBUG=false
APP_URL=http://your-domain.com
```

## 📝 常用维护命令

### 查看日志
```bash
# Laravel 日志
tail -f /var/www/supermarket-laravel/storage/logs/laravel.log

# Web 服务器日志
tail -f /var/log/apache2/supermarket-laravel_error.log
# 或
tail -f /var/log/nginx/supermarket-laravel_error.log
```

### 更新应用
```bash
cd /var/www/supermarket-laravel

# 更新代码
git pull origin main

# 更新依赖
composer install --no-dev --optimize-autoloader

# 运行迁移
php artisan migrate

# 清除缓存
php artisan config:clear
php artisan cache:clear
```

### 重启服务
```bash
# Apache
sudo systemctl restart apache2

# Nginx
sudo systemctl restart nginx

# PHP-FPM
sudo systemctl restart php8.1-fpm
```

## 🆘 常见问题解决

### 问题 1: 500 错误
```bash
# 检查日志
tail -f /var/www/supermarket-laravel/storage/logs/laravel.log

# 检查权限
sudo chown -R www-data:www-data /var/www/supermarket-laravel
sudo chmod -R 755 /var/www/supermarket-laravel
```

### 问题 2: 数据库连接错误
```bash
# 测试数据库连接
php artisan tinker
>>> DB::connection()->getPdo();
```

### 问题 3: 文件权限问题
```bash
# 设置正确的权限
sudo chown -R www-data:www-data /var/www/supermarket-laravel
sudo chmod -R 755 /var/www/supermarket-laravel
sudo chmod -R 775 /var/www/supermarket-laravel/storage
sudo chmod -R 775 /var/www/supermarket-laravel/bootstrap/cache
```

## 📞 技术支持

如果遇到问题，请检查：
1. 服务器错误日志
2. Laravel 应用日志
3. 数据库连接状态
4. 文件权限设置
5. Web 服务器配置

---

**部署完成后，你的 Laravel 超市系统就可以在服务器上正常运行了！** 🎉

## 📋 部署检查清单

- [ ] 项目文件已上传到服务器
- [ ] Composer 已安装
- [ ] PHP 8.1+ 已安装
- [ ] 项目依赖已安装
- [ ] .env 文件已配置
- [ ] 应用密钥已生成
- [ ] 数据库已创建并配置
- [ ] 数据库迁移已运行
- [ ] Web 服务器已配置
- [ ] 文件权限已设置
- [ ] 防火墙已配置
- [ ] 应用可以正常访问 