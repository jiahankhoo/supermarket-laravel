# 在线部署聊天功能故障排除指南

## 问题描述
在线部署后聊天功能发送失败，显示"发送失败，请重试"错误。

## 常见原因和解决方案

### 1. 存储链接问题

**问题**: 在线服务器没有正确创建存储链接，导致文件无法访问。

**解决方案**:
```bash
# 在服务器上运行
cd /var/www/supermarket-laravel
php artisan storage:link

# 如果符号链接创建失败，手动复制文件
cp -r storage/app/public/* public/storage/
chmod -R 755 public/storage/
```

### 2. 文件权限问题

**问题**: 文件权限设置不正确，导致无法写入或读取文件。

**解决方案**:
```bash
# 设置正确的文件权限
sudo chown -R www-data:www-data /var/www/supermarket-laravel
sudo chmod -R 755 /var/www/supermarket-laravel
sudo chmod -R 777 storage/
sudo chmod -R 777 bootstrap/cache/
```

### 3. PHP配置限制

**问题**: PHP的上传文件大小限制过小。

**解决方案**:
编辑 `php.ini` 文件：
```ini
upload_max_filesize = 500M
post_max_size = 500M
max_execution_time = 300
memory_limit = 512M
```

或者在 `.htaccess` 文件中添加：
```apache
php_value upload_max_filesize 500M
php_value post_max_size 500M
php_value max_execution_time 300
php_value memory_limit 512M
```

### 4. 数据库连接问题

**问题**: 数据库连接失败或表不存在。

**解决方案**:
```bash
# 检查数据库连接
php artisan tinker
>>> DB::connection()->getPdo();

# 运行迁移
php artisan migrate

# 检查表是否存在
php artisan tinker
>>> Schema::hasTable('chat_messages');
```

### 5. CSRF Token问题

**问题**: CSRF token验证失败。

**解决方案**:
检查 `resources/views/chat/show.blade.php` 中是否有：
```html
<meta name="csrf-token" content="{{ csrf_token() }}">
```

### 6. 路由问题

**问题**: 路由配置不正确。

**解决方案**:
```bash
# 清除路由缓存
php artisan route:clear
php artisan config:clear
php artisan cache:clear

# 检查路由是否正确注册
php artisan route:list | grep chat
```

## 快速修复脚本

运行提供的修复脚本：
```bash
php fix_chat_issues.php
```

## 调试步骤

### 1. 检查日志文件
```bash
tail -f storage/logs/laravel.log
```

### 2. 检查浏览器控制台
打开浏览器开发者工具，查看Network和Console标签页的错误信息。

### 3. 测试API端点
```bash
# 测试聊天发送API
curl -X POST https://your-domain.com/chat/send/1 \
  -H "Content-Type: application/json" \
  -H "X-CSRF-TOKEN: your-csrf-token" \
  -d '{"message":"test"}'
```

### 4. 检查文件系统
```bash
# 检查存储目录
ls -la storage/app/public/
ls -la public/storage/

# 检查文件权限
stat storage/app/public/chat_files/
stat public/storage/chat_files/
```

## 服务器配置检查

### Apache配置
确保 `.htaccess` 文件存在且内容正确：
```apache
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteRule ^(.*)$ public/$1 [L]
</IfModule>
```

### Nginx配置
确保配置包含：
```nginx
location / {
    try_files $uri $uri/ /index.php?$query_string;
}
```

## 常见错误代码

| 错误代码 | 含义 | 解决方案 |
|---------|------|----------|
| 401 | 未授权 | 检查用户登录状态 |
| 403 | 禁止访问 | 检查用户权限 |
| 422 | 验证失败 | 检查请求数据格式 |
| 500 | 服务器错误 | 查看Laravel日志 |

## 预防措施

### 1. 部署前检查
- 确保所有依赖已安装
- 检查环境配置
- 测试数据库连接
- 验证文件权限

### 2. 部署后验证
- 测试基本功能
- 检查文件上传
- 验证聊天功能
- 查看错误日志

### 3. 监控和维护
- 定期检查日志文件
- 监控磁盘空间
- 备份重要数据
- 更新依赖包

## 联系支持

如果问题仍然存在，请提供以下信息：
1. 服务器环境（操作系统、PHP版本、Web服务器）
2. 错误日志内容
3. 浏览器控制台错误信息
4. 网络请求的响应状态码
